(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{71:function(e,t,a){a("j36g"),a("55Il"),e.exports=a("Z3xQ")},KUpD:function(e,t,a){e.exports={"install-page-wrapper":"_2145f6w_gvAx5jbCLSvNm1","install-page":"_1ucR52TRm2uhcZJhUjsxqG"}},Z3xQ:function(e,t,a){"use strict";a.r(t);var n=a("zkrS"),r=a("7eYF"),s=a("aqSL"),o=a("lw2U"),c=a("+Cau"),i=a("rbsZ"),l=a("abHt"),p=(a("RJdT"),a("o0o1")),d=a.n(p),u=a("8fIB"),m=a.n(u),w=a("yXPU"),h=a.n(w),f=a("q1tI"),g=a.n(f),v=a("i8i4"),b=a.n(v),k=a("XkTy"),N=a("lwsE"),E=a.n(N),P=a("7W2i"),M=a.n(P),x=a("W8MJ"),y=a.n(x),S=a("a1gu"),C=a.n(S),j=a("Nsbk"),I=a.n(j),B=a("PJYZ"),_=a.n(B),T=a("lSNA"),O=a.n(T),A=a("17x9"),D=a("ldhK"),R=a.n(D),W="/images/sharing/wechat_".concat(window.MBLocale,".png"),q="/images/sharing/ios_".concat(window.MBLocale,".png"),U=function(e){function t(){var e,a,n;E()(this,t);for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return C()(n,(a=n=C()(this,(e=I()(t)).call.apply(e,[this].concat(s))),O()(_()(_()(n)),"handleClick",function(){n.props.onClose()}),a))}return y()(t,[{key:"render",value:function(){var e=this.props.show,t=MB.isWechat(),a=!t&&MB.isIOS(),n=MB.isiPad(),r=!(t||a),s={display:e?"":"none"};return g.a.createElement("div",{className:R.a.covers,style:s,onClick:this.handleClick},t&&g.a.createElement("div",{className:"cover wechat"},g.a.createElement("img",{className:"robot",src:"/images/sharing/robot.png"}),g.a.createElement("img",{className:"tips",src:W}),"s",g.a.createElement("div",{className:"arrow"})),a&&!n&&g.a.createElement("div",{className:"cover ios"},g.a.createElement("img",{className:"robot",src:"/images/sharing/robot.png"}),g.a.createElement("img",{className:"tips",src:q}),g.a.createElement("div",{className:"arrow"})),n&&g.a.createElement("div",{className:"cover ipad"},g.a.createElement("img",{className:"robot",src:"/images/sharing/robot.png"}),g.a.createElement("img",{className:"tips",src:q}),g.a.createElement("div",{className:"arrow"})),r&&g.a.createElement("div",{className:"cover building"},g.a.createElement("div",{className:"tip-wrapper"},g.a.createElement("p",{className:"tip"},I18N.building_apk),g.a.createElement("div",{className:"spinner"}))))}}]),M()(t,e),t}(f.PureComponent);U.propTypes={show:A.PropTypes.bool,onClose:A.PropTypes.func};var L=a("KUpD"),J=a.n(L),K=a("UbMB"),G=a.n(K),Z=a("t3Un"),F=G.a.bind(J.a),Q=function(){var e=h()(d.a.mark(function e(t){var a,n,r;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return MB.event("移动端: 点击下载 APK","运行页"),e.next=3,Object(Z.b)("/app/".concat(t,"/build/apk.json"),null,{method:"PUT"});case 3:return e.next=6,Y(5e3);case 6:return e.next=8,Object(Z.b)("/app/".concat(t,"/status/apk.json"));case 8:if(a=e.sent,n=a.progress,r=a.link,100===n){e.next=13;break}return e.abrupt("continue",3);case 13:return window.location=r,e.abrupt("return");case 17:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),Y=function(e){return new m.a(function(t){return setTimeout(t,e)})},H=function(e,t){MB.event("移动端: 点击下载安卓客户端","运行页");var a=window.location,n=a.hostname,r=a.pathname,s=navigator.userAgent.toLowerCase(),o=document.createElement("iframe");if(document.body.appendChild(o),o.style.cssText="display:none;width=0;height=0",setTimeout(function(){window.location=e},200),console.log("userAgent",s),s.includes("chrome")&&s.includes("android")&&!s.includes("ucbrowser")&&!s.includes("quark")){var c="intent://".concat(n).concat(r,"?password=").concat(t,"#Intent;package=com.mockingbot;scheme=mockingbot;S.browser_fallback_url=").concat(e,";end");o.src=c}else{var i="mockingbot://".concat(n).concat(r,"?password=").concat(t);window.open(i)}},V=function(e,t){MB.event("移动端: 点击下载 iOS 客户端","运行页");var a=window.location,n=a.hostname,r=a.pathname,s="modao://".concat(n).concat(r,"?password=").concat(t);setTimeout(function(){window.location=e},25),window.location=s},X=function(e){function t(){var e;return E()(this,t),e=C()(this,I()(t).call(this)),O()(O()(O()(O()(_()(_()(e)),"handleView",function(t){t.preventDefault(),e.props.loadProject()}),"handleInstall",function(t){t.preventDefault();var a=e.props.project,n=a.accessToken,r=a.userPlan,s=a.exportable;MB.isWechat()?e.setState({isCoverShow:!0}):MB.isiPad()||MB.isIOS()?e.setState({isCoverShow:!0}):s?(e.setState({isCoverShow:!0}),Q(n).then(function(){return e.setState({isCoverShow:!1})}).catch(function(e){})):MB.promptRenew("exportable",{format:"apk",role:"project",plan:r})}),"handleDownload",function(t){var a=e.props.encryptedPassword;MB.isWechat()?e.setState({isCoverShow:!0}):MB.isIOS()?V(t,a):MB.isAndroid()&&H(t,a)}),"handleCloseCover",function(){e.setState({isCoverShow:!1})}),e.state={isCoverShow:!1},e}return y()(t,[{key:"componentDidMount",value:function(){$("#splash").hide(),$("#workspace").show(),$.timeago.settings.lang=window.MBLocale,$(".timeago").timeago()}},{key:"render",value:function(){var e=this,t=this.props.project,a=t.name,n=t.iconUrl,r=t.updatedAt,s=t.ios_client_url,o=t.android_client_url,c=this.state.isCoverShow,i=MB.isAndroid(),l=i?o:s,p=i?I18N.download_android_apk:I18N.add_to_home_screen;return g.a.createElement("div",{className:F("install-page-wrapper")},g.a.createElement("div",{className:F("install-page",{"is-wechat":MB.isWechat()})},g.a.createElement("div",{className:"app-inner"},g.a.createElement("img",{className:"app-icon",src:n}),g.a.createElement("h1",{className:"app-name"},a),g.a.createElement("div",{className:"app-update-time"},g.a.createElement("time",{className:"timeago",dateTime:r}),I18N.update),g.a.createElement("div",{className:"install-btns"},g.a.createElement("a",{className:"install-btn primary",onClick:function(){return e.handleDownload(l)}},I18N.open_in_client),g.a.createElement("a",{className:"install-btn",onClick:this.handleView},I18N.view_app)),g.a.createElement("a",{className:"download-btn",onClick:this.handleInstall},g.a.createElement("span",null,p),g.a.createElement("i",{className:"fa fa-angle-right"}))),g.a.createElement(U,{show:c,onClose:this.handleCloseCover})))}}]),M()(t,e),t}(f.PureComponent);O()(X,"propTypes",{project:A.PropTypes.object,loadProject:A.PropTypes.func,encryptedPassword:A.PropTypes.string});var z=window,ee=z.$,te=z.MB,ae=z.MBLocale,ne=z.md5,re=z.Pusher,se=z.AutoSaver,oe=z.SharingRunner,ce=te.localStorageDelegate,ie=function(){return!!window.MBData},le=/\/embed\b/.test(location.pathname);te.f.inSharing=!0;var pe=function(e,t){return t||new URLSearchParams(location.search).get("password")||ce.getItem("".concat(e,"_pwd"))};te.load=function(){var e=h()(d.a.mark(function e(t){var a,n,r,s,o,c,i,l;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.token,n=t.isPasswordRequired,r=t.encryptedPassword,s=t.installerProject,te.webpackInterface.renderPreviewAlert(),o=pe(a,r),c=!te.isStandAlone()&&!te.isInApp&&te.isMobile()&&!ie()&&!le,te.supportedBrowser()){e.next=8;break}return ee("#splash").hide(),ee("#loading").hide(),e.abrupt("return");case 8:if(i=te.isMac()?"mac":te.isWindows()?"windows":"other-os",ee("html").addClass(i),(te.isStandAlone()||te.isIOSClient())&&ee("html").addClass("is-full-screen"),!c){e.next=17;break}return e.next=14,ue({token:a,isPasswordRequired:n,savedEncryptedPassword:o,shouldGetData:!1});case 14:return ee("#loading").hide(),e.next=17,new m.a(function(e){b.a.render(g.a.createElement(X,{project:s,loadProject:e,encryptedPassword:pe(a,r)}),document.getElementById("workspace"))});case 17:return e.next=19,ue({token:a,isPasswordRequired:n,savedEncryptedPassword:pe(a,r)});case 19:return l=e.sent,e.abrupt("return",ie()?he(l):l?we(l):null);case 21:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}();var de=function(){var e=h()(d.a.mark(function e(t){var a,n,r,s,o,c,i;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.token,n=t.encryptedPassword,r=t.shouldGetData,s=void 0===r||r,o=window.MBData,!ie()){e.next=6;break}if(!o.project.password||n===o.project.password){e.next=5;break}throw new Error("Wrong password!");case 5:return e.abrupt("return",o);case 6:if(s){e.next=14;break}return e.next=9,fetch("/app/".concat(a,"/checkpassword?password=").concat(n));case 9:if(c=e.sent,c.ok){e.next=13;break}throw new Error("Wrong password!");case 13:return e.abrupt("return",!0);case 14:return i="/app/".concat(a,".json?").concat((new Date).valueOf()).concat(n?"&password=".concat(n):""),e.abrupt("return",me(i));case 16:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),ue=function(){var e=h()(d.a.mark(function e(t){var a,n,r,s,o,c,i;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.token,n=t.isPasswordRequired,r=t.savedEncryptedPassword,s=t.shouldGetData,o=void 0===s||s,e.prev=1,e.next=4,de({token:a,shouldGetData:o,encryptedPassword:r});case 4:c=e.sent,e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),console.log("Invalid saved password: ".concat(e.t0,". Will retry with prompt.")),ce.removeItem("".concat(a,"_pwd"));case 11:if(c){e.next=33;break}if(e.prev=12,!n){e.next=25;break}return e.t1=ne,e.next=17,Object(k.c)({desc:I18N.credential_required});case 17:return e.t2=e.sent,i=(0,e.t1)(e.t2),e.next=21,de({token:a,shouldGetData:o,encryptedPassword:i});case 21:c=e.sent,ce.setItem("".concat(a,"_pwd"),i),e.next=26;break;case 25:Object(k.a)({desc:I18N.no_permission_to_app});case 26:e.next=33;break;case 28:return e.prev=28,e.t3=e.catch(12),console.log("Invalid prompt password:",e.t3),setTimeout(function(){return Object(k.a)({desc:n?I18N.invalid_credential:"Failed to load this app."})},320),e.abrupt("return",null);case 33:return e.abrupt("return",c);case 34:case"end":return e.stop()}},e,this,[[1,7],[12,28]])}));return function(t){return e.apply(this,arguments)}}(),me=function(e){return new m.a(function(t,a){return ee.getJSON(e,function(e){return t(e)}).fail(function(e,t,n){return a(n)})})},we=function(e){ee(".indicator").css("height","100%"),setTimeout(function(){return fe(e)},300)},he=function(e){te.staticMap=function(){return"images/workspace/staticmap_".concat(ae,".png")},e.project.splash="images/splash.png",e.screens.forEach(function(e){e.bgimage&&(e.bgimage=e.bgimage.replace(/^.+uploads.*?\//,""))}),e.widgets.forEach(function(e){e.image&&(e.image=e.image.replace(/^.+uploads.*?\//,""))}),e.widgetstates.forEach(function(e){e.image&&(e.image=e.image.replace(/^.+uploads.*?\//,""))}),ee(".indicator").css("height","100%"),setTimeout(function(){return fe(e)},300)},fe=function(e){var t=e.project.template?new Template:e.project.combo?new Combo:new Project;t.load(e.project),t.lsave(!1),te.currentProject=t,Template.refresh(e.templates),Screen.refresh(e.screens),Widget.refresh(e.widgets),Link.refresh(e.links),Panel.refresh(e.panels),Screenstate.refresh(e.screenstates),Widgetstate.refresh(e.widgetstates),Panelstate.refresh(e.panelstates),Collaborator.refresh(e.collaborators),CommentThread.refresh(e.threads),Comment.refresh(e.comments),Team.refresh(e.teams),te.user=ee("#workspace").data("user")||{},te.user.id&&(te.pusher=new re,te.pusher.subscribe(t.cid)),te.isMobile()||(te.autoSaver=new se),(new Image).src=te.staticMap(),ee("title").html(t.name),ee("#loading").hide(),!t.validated&&te.isMobile()&&Object(k.a)({title:I18N.reminder,desc:I18N.fraud_warning,confirmText:I18N.fraud_confirm,isHTML:!0}),te.checkFA(function(){ee(".box").hide(),te.currentProject=t,te.webpackInterface.init(),te.runner=new oe(t),te.runner.render()})};a("KKmY"),a("P3rE"),a("dppN"),a("T7iu");MB.COMPONENTS=l.b;try{n.a.MB.webpackInterface=Object(r.a)(s.a),n.a.MB.setRunnerExtra=o.a,n.a.MB.renewMsg=i.a,n.a.MB.promptRenew=i.c,n.a.MB.messageBucket=Object(c.a)(c.b)}catch(e){console.warn("[UI:Preview] Failed to init:",e.stack||e)}},ldhK:function(e,t,a){e.exports={covers:"_2fva7dqNrMTA3qQj2Sag2u"}}},[[71,0,1,2]]]);
//# sourceMappingURL=preview-3c0e9e34e15eb64b1a54.js.map